<!doctype html><meta charset="utf-8"/>
<title>Play</title><meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  html,body{margin:0;height:100%;background:#0b0b0e;color:#fff;font-family:system-ui}
  #hud{position:fixed;left:12px;top:12px;background:rgba(0,0,0,.35);padding:8px 10px;border-radius:8px}
  #lb{position:fixed;right:12px;top:12px;background:rgba(0,0,0,.35);padding:8px 10px;border-radius:8px;max-width:42ch}
  canvas{display:block;width:100vw;height:100vh;image-rendering:pixelated}
</style>
<div id="hud">Loadingâ€¦</div><div id="lb"></div><canvas id="cv"></canvas>
<script>
function fromB64url(s){try{return JSON.parse(atob(s.replace(/-/g,'+').replace(/_/g,'/')))}catch(_){return{}}}
const q = new URLSearchParams(location.search);
const cfg = fromB64url(q.get('data')||'');
const HUD = document.getElementById('hud'); const LB = document.getElementById('lb');
HUD.textContent = cfg.prompt ? `ðŸŽ® ${cfg.prompt}` : 'ðŸŽ®';

const cv=document.getElementById('cv'), ctx=cv.getContext('2d');
function fit(){cv.width=innerWidth;cv.height=innerHeight} addEventListener('resize',fit); fit();

const bg=new Image(), spr=new Image();
bg.src = (cfg.assets&&cfg.assets.background_url)||''; spr.src=(cfg.assets&&cfg.assets.sprite_url)||'';
let ready=0; const onr=()=>{if(++ready===2) start()}; bg.onload=onr; spr.onload=onr; setTimeout(()=>{if(ready<2) start()},800);

let startMs=Date.now(), score=0;
async function submitScore(){
  try{
    const body = { slug: cfg.slug, score, run_ms: Date.now()-startMs, seed: cfg.seed, issued_at: cfg.issued_at, play_sig: cfg.play_sig };
    await fetch('/api/score',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)});
    const r = await fetch('/api/leaderboard?slug='+encodeURIComponent(cfg.slug)); const j = await r.json();
    if (j.ok) LB.innerHTML = '<b>Top scores</b><br>' + j.top.map(x=>`${x.score} pts Â· ${ (x.run_ms/1000)|0 }s`).slice(0,5).join('<br>');
  }catch(e){ /* ignore */ }
}

function start(){
  const mech=cfg.mechanics||{speed:1,spawn_rate:1,gravity:0};
  let t=0,x=120,y=cv.height-160,vy=0;
  const gravity=0.6*(mech.gravity||0), speed=2.5*(mech.speed||1);

  // auto-end after 30s and submit score
  setTimeout(()=>submitScore(), 30000);

  (function loop(){
    t+=1;
    if(bg.src){ const r=bg.width/bg.height, w=cv.width, h=w/r, y0=(cv.height-h)/2; ctx.drawImage(bg,0,y0,w,h); }
    else{ const g=ctx.createLinearGradient(0,0,0,cv.height); g.addColorStop(0,'#1b1b22'); g.addColorStop(1,'#2c2f58'); ctx.fillStyle=g; ctx.fillRect(0,0,cv.width,cv.height); }

    vy+=gravity; y+=vy; if(y>cv.height-160){ y=cv.height-160; vy=-12*(mech.speed||1); score+=10; HUD.textContent=`ðŸŽ® ${cfg.prompt||''} Â· ${score} pts`; }
    x=(x+speed)%(cv.width+200);

    const W=128,H=128;
    if(spr.src) ctx.drawImage(spr,0,0,spr.width,spr.height,x-64,y-64,W,H);
    else { ctx.fillStyle='#8F4AE6'; ctx.fillRect(x-40,y-40,80,80); }

    requestAnimationFrame(loop);
  })();
}
</script>
